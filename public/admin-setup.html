<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Setup Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }
        .section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fafafa;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button.danger {
            background-color: #dc3545;
        }
        button.danger:hover {
            background-color: #c82333;
        }
        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px;
            width: 200px;
        }
        .result {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .user-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            background: white;
        }
        .user-item {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .user-info {
            flex: 1;
        }
        .tier-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            color: white;
        }
        .tier-free { background-color: #6c757d; }
        .tier-pro { background-color: #28a745; }
        .tier-business { background-color: #007bff; }
        .tier-admin { background-color: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ”§ Admin Setup Tool</h1>
        
        <div class="section">
            <h3>1. Check Current Users</h3>
            <p>First, let's see what users exist in your database and their current tiers:</p>
            <button onclick="checkUsers()">Load Users</button>
            <div id="users-result" class="result" style="display: none;"></div>
            <div id="users-list" class="user-list" style="display: none;"></div>
        </div>

        <div class="section">
            <h3>2. Set User as Admin</h3>
            <p>Enter a user email to make them admin:</p>
            <input type="email" id="admin-email" placeholder="user@example.com">
            <button onclick="setUserAsAdmin()">Make Admin</button>
            <div id="admin-result" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h3>3. Test Admin Access</h3>
            <p>Test if the admin authentication is working:</p>
            <button onclick="testAdminAccess()">Test Admin API</button>
            <div id="test-result" class="result" style="display: none;"></div>
        </div>

        <div class="section">
            <h3>4. Firebase Console Instructions</h3>
            <p>If the automated tools don't work, you can manually set admin status in Firebase Console:</p>
            <ol>
                <li>Go to <a href="https://console.firebase.google.com" target="_blank">Firebase Console</a></li>
                <li>Select your project: <strong>glow-editor</strong></li>
                <li>Navigate to <strong>Firestore Database</strong></li>
                <li>Find the user document: <code>users/{userId}</code></li>
                <li>Edit the document and add/update these fields:</li>
            </ol>
            <pre style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin: 10px 0;">
{
  "tier": "admin",
  "subscriptionTier": "admin",
  "subscription": {
    "plan": "admin",
    "status": "active"
  }
}</pre>
        </div>
    </div>

    <script>
        let currentUsers = [];

        async function makeRequest(url, options = {}) {
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    }
                });
                const data = await response.json();
                return { response, data };
            } catch (error) {
                return { error: error.message };
            }
        }

        async function checkUsers() {
            const resultDiv = document.getElementById('users-result');
            const listDiv = document.getElementById('users-list');
            
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'Loading users...';

            const { response, data, error } = await makeRequest('/api/admin/debug');
            
            if (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `Error: ${error}`;
                return;
            }

            if (!response.ok) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `API Error: ${data.error}\nDetails: ${JSON.stringify(data.details, null, 2)}`;
                return;
            }

            currentUsers = data.firestoreUsers || [];
            
            resultDiv.className = 'result success';
            resultDiv.textContent = `Found ${data.counts.firestore} users in Firestore, ${data.counts.admins} admins`;
            
            // Display user list
            listDiv.style.display = 'block';
            listDiv.innerHTML = currentUsers.map(user => `
                <div class="user-item">
                    <div class="user-info">
                        <strong>${user.email}</strong><br>
                        <small>Username: ${user.username || 'N/A'} | UID: ${user.uid}</small>
                    </div>
                    <div>
                        <span class="tier-badge tier-${user.tier}">${user.tier}</span>
                        <button onclick="changeTier('${user.uid}', '${user.email}')">Change Tier</button>
                    </div>
                </div>
            `).join('');
        }

        async function changeTier(userId, userEmail) {
            const newTier = prompt(`Change tier for ${userEmail}?\nCurrent options: free, pro, business, admin`, 'admin');
            if (!newTier) return;

            const validTiers = ['free', 'pro', 'business', 'admin'];
            if (!validTiers.includes(newTier)) {
                alert('Invalid tier! Use: free, pro, business, or admin');
                return;
            }

            // For now, we'll use the Firestore approach since we might not have auth tokens
            const resultDiv = document.getElementById('admin-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = `Updating user ${userEmail} to ${newTier}...`;

            // Since we can't easily make authenticated requests from this static page,
            // we'll provide instructions for manual update
            resultDiv.className = 'result info';
            resultDiv.textContent = `To update user ${userEmail} (${userId}) to ${newTier} tier:

1. Go to Firebase Console â†’ Firestore Database
2. Navigate to users/${userId}
3. Update the document with:
   {
     "tier": "${newTier}",
     "subscriptionTier": "${newTier}",
     "subscription": {
       "plan": "${newTier}",
       "status": "active"
     }
   }

Or use the Firebase Admin SDK with this code:
await db.collection('users').doc('${userId}').update({
  tier: '${newTier}',
  subscriptionTier: '${newTier}',
  'subscription.plan': '${newTier}'
});`;
        }

        async function setUserAsAdmin() {
            const email = document.getElementById('admin-email').value;
            if (!email) {
                alert('Please enter an email address');
                return;
            }

            const user = currentUsers.find(u => u.email === email);
            if (!user) {
                alert('User not found. Please load users first and make sure the email exists.');
                return;
            }

            changeTier(user.uid, user.email);
        }

        async function testAdminAccess() {
            const resultDiv = document.getElementById('test-result');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'Testing admin access...';

            // Try to access a protected admin endpoint
            const { response, data, error } = await makeRequest('/api/admin/platform/users?range=7d');
            
            if (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `Network Error: ${error}`;
                return;
            }

            resultDiv.className = response.ok ? 'result success' : 'result error';
            
            if (response.ok) {
                resultDiv.textContent = `âœ… Admin API is accessible!\nLoaded ${data.users?.length || 0} users`;
            } else {
                resultDiv.textContent = `âŒ Admin API access denied: ${data.error}\nStatus: ${response.status}`;
            }
        }

        // Auto-load users when page loads
        window.addEventListener('load', () => {
            setTimeout(checkUsers, 1000);
        });
    </script>
</body>
</html>
